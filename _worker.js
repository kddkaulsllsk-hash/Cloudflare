// <!--GAMFC-->version base on commit: 9f1a93515106edbaea05f3cbea24f7a5b9ffba0c - last update: 2025-12-09 23:31:33 UTC <!--GAMFC-END-->.

import{connect}from'cloudflare:sockets';const Config={'userID':'d342d11e-d424-4583-b36e-524ab1f0afa4','proxyIPs':['nima.nscl.ir:443','bpb.yousef.isegaro.com:443'],'scamalytics':{'username':'','apiKey':'','baseUrl':'https://api12.scamalytics.com/v3/'},'socks5':{'enabled':![],'relayMode':![],'address':''},async 'fromEnv'(a){try{let b=null;if(a['D1'])try{const {results:f}=await a['D1']['prepare']('SELECT\x20ip_port\x20FROM\x20proxy_health\x20WHERE\x20is_healthy\x20=\x201\x20ORDER\x20BY\x20latency_ms\x20ASC\x20LIMIT\x201')['all']();b=f[0x0]?.['ip_port']||null,b&&console['log']('✅\x20Using\x20best\x20healthy\x20proxy\x20IP\x20from\x20D1:\x20'+b);}catch(g){console['warn']('⚠️\x20Failed\x20to\x20read\x20proxy\x20health\x20from\x20D1:\x20'+g['message']+'\x20-\x20Using\x20fallback');}!b&&(b=a['PROXYIP'],b&&console['log']('✅\x20Using\x20proxy\x20IP\x20from\x20env.PROXYIP:\x20'+b));!b&&(b=this['proxyIPs'][Math['floor'](Math['random']()*this['proxyIPs']['length'])],b&&console['log']('✅\x20Using\x20proxy\x20IP\x20from\x20hardcoded\x20list:\x20'+b));!b&&(console['error']('❌\x20CRITICAL:\x20No\x20proxy\x20IP\x20could\x20be\x20determined\x20-\x20Using\x20default\x20fallback'),b=this['proxyIPs'][0x0]);const [c,d='443']=b['split'](':');return{'userID':a['UUID']||this['userID'],'proxyIP':c,'proxyPort':parseInt(d,0xa),'proxyAddress':b,'scamalytics':{'username':a['SCAMALYTICS_USERNAME']||this['scamalytics']['username'],'apiKey':a['SCAMALYTICS_API_KEY']||this['scamalytics']['apiKey'],'baseUrl':a['SCAMALYTICS_BASEURL']||this['scamalytics']['baseUrl']},'socks5':{'enabled':!!a['SOCKS5'],'relayMode':a['SOCKS5_RELAY']==='true'||this['socks5']['relayMode'],'address':a['SOCKS5']||this['socks5']['address']}};}catch(h){return console['error']('❌\x20Config.fromEnv\x20failed:\x20'+h['message']+'\x20-\x20Using\x20defaults'),{'userID':this['userID'],'proxyIP':this['proxyIPs'][0x0]['split'](':')[0x0],'proxyPort':0x1bb,'proxyAddress':this['proxyIPs'][0x0],'scamalytics':this['scamalytics'],'socks5':this['socks5']};}}},CONST={'ED_PARAMS':{'ed':0xa00,'eh':'Sec-WebSocket-Protocol'},'VLESS_PROTOCOL':'vless','WS_READY_STATE_OPEN':0x1,'WS_READY_STATE_CLOSING':0x2,'ADMIN_LOGIN_LOGIN_FAIL_LIMIT':0x5,'ADMIN_LOGIN_LOCK_TTL':0x258,'SCAMALYTICS_THRESHOLD':0x32,'USER_PATH_RATE_LIMIT':0x14,'USER_PATH_RATE_TTL':0x3c,'AUTO_REFRESH_INTERVAL':0xea60,'IP_CLEANUP_AGE_DAYS':0x1e,'HEALTH_CHECK_INTERVAL':0x493e0,'HEALTH_CHECK_TIMEOUT':0x1388};async function ensureTablesExist(a,b){if(!a['DB'])return console['warn']('⚠️\x20D1\x20database\x20not\x20bound\x20-\x20Running\x20in\x20degraded\x20mode\x20without\x20persistence'),![];const c=['CREATE\x20TABLE\x20IF\x20NOT\x20EXISTS\x20users\x20(\x0a\x20\x20\x20\x20\x20\x20uuid\x20TEXT\x20PRIMARY\x20KEY,\x0a\x20\x20\x20\x20\x20\x20created_at\x20DATETIME\x20DEFAULT\x20CURRENT_TIMESTAMP,\x0a\x20\x20\x20\x20\x20\x20expiration_date\x20TEXT\x20NOT\x20NULL,\x0a\x20\x20\x20\x20\x20\x20expiration_time\x20TEXT\x20NOT\x20NULL,\x0a\x20\x20\x20\x20\x20\x20notes\x20TEXT,\x0a\x20\x20\x20\x20\x20\x20traffic_limit\x20INTEGER,\x0a\x20\x20\x20\x20\x20\x20traffic_used\x20INTEGER\x20DEFAULT\x200,\x0a\x20\x20\x20\x20\x20\x20ip_limit\x20INTEGER\x20DEFAULT\x20-1\x0a\x20\x20\x20\x20)','CREATE\x20TABLE\x20IF\x20NOT\x20EXISTS\x20user_ips\x20(\x0a\x20\x20\x20\x20\x20\x20uuid\x20TEXT,\x0a\x20\x20\x20\x20\x20\x20ip\x20TEXT,\x0a\x20\x20\x20\x20\x20\x20last_seen\x20DATETIME\x20DEFAULT\x20CURRENT_TIMESTAMP,\x0a\x20\x20\x20\x20\x20\x20PRIMARY\x20KEY\x20(uuid,\x20ip),\x0a\x20\x20\x20\x20\x20\x20FOREIGN\x20KEY\x20(uuid)\x20REFERENCES\x20users(uuid)\x20ON\x20DELETE\x20CASCADE\x0a\x20\x20\x20\x20)','CREATE\x20TABLE\x20IF\x20NOT\x20EXISTS\x20key_value\x20(\x0a\x20\x20\x20\x20\x20\x20key\x20TEXT\x20PRIMARY\x20KEY,\x0a\x20\x20\x20\x20\x20\x20value\x20TEXT\x20NOT\x20NULL,\x0a\x20\x20\x20\x20\x20\x20expiration\x20INTEGER\x0a\x20\x20\x20\x20)','CREATE\x20TABLE\x20IF\x20NOT\x20EXISTS\x20proxy_health\x20(\x0a\x20\x20\x20\x20\x20\x20ip_port\x20TEXT\x20PRIMARY\x20KEY,\x0a\x20\x20\x20\x20\x20\x20is_healthy\x20INTEGER\x20NOT\x20NULL,\x0a\x20\x20\x20\x20\x20\x20latency_ms\x20INTEGER,\x0a\x20\x20\x20\x20\x20\x20last_check\x20INTEGER\x20DEFAULT\x20(strftime(\x27%s\x27,\x20\x27now\x27))\x0a\x20\x20\x20\x20)'];try{const d=c['map'](f=>a['DB']['prepare'](f));return await a['DB']['batch'](d),console['log']('✅\x20D1\x20tables\x20ensured/created\x20successfully'),!![];}catch(f){return console['error']('❌\x20Failed\x20to\x20create\x20D1\x20tables:\x20'+f['message']+'\x20-\x20Worker\x20will\x20continue\x20with\x20limited\x20functionality'),![];}}function generateNonce(){const a=new Uint8Array(0x10);return crypto['getRandomValues'](a),btoa(String['fromCharCode']['apply'](null,a));}function addSecurityHeaders(a,b,c={}){const d=['default-src\x20\x27self\x27','form-action\x20\x27self\x27','object-src\x20\x27none\x27','frame-ancestors\x20\x27none\x27','base-uri\x20\x27self\x27',b?'script-src\x20\x27nonce-'+b+'\x27\x20\x27unsafe-inline\x27\x20https://cdnjs.cloudflare.com\x20https://unpkg.com':'script-src\x20\x27self\x27\x20https://cdnjs.cloudflare.com\x20https://unpkg.com\x20\x27unsafe-inline\x27','style-src\x20\x27self\x27\x20\x27unsafe-inline\x27\x20\x27unsafe-hashes\x27',('img-src\x20\x27self\x27\x20data:\x20https:\x20blob:\x20'+(c['img']||''))['trim'](),('connect-src\x20\x27self\x27\x20https:\x20'+(c['connect']||''))['trim']()];a['set']('Content-Security-Policy',d['join'](';\x20')),a['set']('Strict-Transport-Security','max-age=63072000;\x20includeSubDomains;\x20preload'),a['set']('X-Content-Type-Options','nosniff'),a['set']('X-Frame-Options','SAMEORIGIN'),a['set']('Referrer-Policy','strict-origin-when-cross-origin'),a['set']('Permissions-Policy','camera=(),\x20microphone=(),\x20geolocation=(),\x20payment=(),\x20usb=()'),a['set']('alt-svc','h3=\x22:443\x22;\x20ma=0'),a['set']('Cross-Origin-Opener-Policy','same-origin'),a['set']('Cross-Origin-Embedder-Policy','require-corp'),a['set']('Cross-Origin-Resource-Policy','same-origin');}function timingSafeEqual(c,d){if(typeof c!=='string'||typeof d!=='string')return![];const e=c['length'],f=d['length'];let g=0x0;if(e!==f){for(let h=0x0;h<e;h++){g|=c['charCodeAt'](h)^c['charCodeAt'](h);}return![];}for(let j=0x0;j<e;j++){g|=c['charCodeAt'](j)^d['charCodeAt'](j);}return g===0x0;}function escapeHTML(a){if(typeof a!=='string')return'';return a['replace'](/[&<>"']/g,b=>({'&':'&amp;','<':'&lt;','>':'&gt;','\x22':'&quot;','\x27':'&#39;'}[b]));}function generateUUID(){return crypto['randomUUID']();}function isValidUUID(a){if(typeof a!=='string')return![];const b=/^[0-9a-f]{8}-[0-9a-f]{4}-[1-5][0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}$/i;return b['test'](a);}function isExpired(a,b){if(!a||!b)return!![];try{const c=b['includes'](':')&&b['split'](':')['length']===0x2?b+':00':b,d=c['split']('.')[0x0],f=new Date(a+'T'+d+'Z');return f<=new Date()||isNaN(f['getTime']());}catch(g){return console['error']('isExpired\x20error:\x20'+g['message']),!![];}}async function formatBytes(a){if(a===0x0)return'0\x20Bytes';const b=0x400,c=['Bytes','KB','MB','GB','TB'],d=Math['floor'](Math['log'](a)/Math['log'](b));return parseFloat((a/Math['pow'](b,d))['toFixed'](0x2))+'\x20'+c[d];}async function kvGet(a,b,c='text'){if(!a)return console['warn']('⚠️\x20kvGet\x20called\x20without\x20database\x20for\x20key:\x20'+b),null;try{const d=a['prepare']('SELECT\x20value,\x20expiration\x20FROM\x20key_value\x20WHERE\x20key\x20=\x20?')['bind'](b),f=await d['first']();if(!f)return null;if(f['expiration']&&f['expiration']<Math['floor'](Date['now']()/0x3e8))return await a['prepare']('DELETE\x20FROM\x20key_value\x20WHERE\x20key\x20=\x20?')['bind'](b)['run'](),null;if(c==='json')try{return JSON['parse'](f['value']);}catch(g){return console['error']('Failed\x20to\x20parse\x20JSON\x20for\x20key\x20'+b+':\x20'+g['message']),null;}return f['value'];}catch(h){return console['error']('kvGet\x20error\x20for\x20'+b+':\x20'+h['message']),null;}}async function kvPut(a,b,c,d={}){if(!a){console['warn']('⚠️\x20kvPut\x20called\x20without\x20database\x20for\x20key:\x20'+b);return;}try{typeof c==='object'&&(c=JSON['stringify'](c));const f=d['expirationTtl']?Math['floor'](Date['now']()/0x3e8+d['expirationTtl']):null;await a['prepare']('INSERT\x20OR\x20REPLACE\x20INTO\x20key_value\x20(key,\x20value,\x20expiration)\x20VALUES\x20(?,\x20?,\x20?)')['bind'](b,c,f)['run']();}catch(g){console['error']('kvPut\x20error\x20for\x20'+b+':\x20'+g['message']);}}async function kvDelete(a,b){if(!a){console['warn']('⚠️\x20kvDelete\x20called\x20without\x20database\x20for\x20key:\x20'+b);return;}try{await a['prepare']('DELETE\x20FROM\x20key_value\x20WHERE\x20key\x20=\x20?')['bind'](b)['run']();}catch(c){console['error']('kvDelete\x20error\x20for\x20'+b+':\x20'+c['message']);}}async function getUserData(a,b,c){if(!isValidUUID(b))return console['warn']('⚠️\x20Invalid\x20UUID\x20format:\x20'+b),null;if(!a['DB'])return console['error']('❌\x20D1\x20binding\x20missing\x20-\x20Cannot\x20retrieve\x20user\x20data'),null;const d='user:'+b;try{const f=await kvGet(a['DB'],d,'json');if(f&&f['uuid'])return console['log']('✅\x20Cache\x20hit\x20for\x20user:\x20'+b),f;}catch(g){console['warn']('⚠️\x20Cache\x20miss\x20for\x20'+b+':\x20'+g['message']);}try{const h=await a['DB']['prepare']('SELECT\x20*\x20FROM\x20users\x20WHERE\x20uuid\x20=\x20?')['bind'](b)['first']();if(!h)return console['warn']('⚠️\x20User\x20not\x20found:\x20'+b),null;const i=kvPut(a['DB'],d,h,{'expirationTtl':0xe10});return c?c['waitUntil'](i):await i,console['log']('✅\x20User\x20data\x20retrieved\x20from\x20DB:\x20'+b),h;}catch(j){return console['error']('❌\x20Failed\x20to\x20retrieve\x20user\x20data\x20for\x20'+b+':\x20'+j['message']),null;}}async function updateUsage(a,b,c,d){if(c<=0x0||!b)return;if(!a['DB']){console['warn']('⚠️\x20Cannot\x20update\x20usage\x20for\x20'+b+':\x20Database\x20not\x20available');return;}const e='usage_lock:'+b;let f=![];try{let g=0x0;while(!f&&g<0x5){const k=await kvGet(a['DB'],e);!k?(await kvPut(a['DB'],e,'locked',{'expirationTtl':0x5}),f=!![]):(await new Promise(l=>setTimeout(l,0x64)),g++);}if(!f){console['warn']('⚠️\x20Could\x20not\x20acquire\x20lock\x20for\x20usage\x20update:\x20'+b);return;}const h=Math['round'](c),i=a['DB']['prepare']('UPDATE\x20users\x20SET\x20traffic_used\x20=\x20traffic_used\x20+\x20?\x20WHERE\x20uuid\x20=\x20?')['bind'](h,b)['run'](),j=kvDelete(a['DB'],'user:'+b);d?d['waitUntil'](Promise['all']([i,j])):await Promise['all']([i,j]),console['log']('✅\x20Usage\x20updated\x20for\x20'+b+':\x20+'+h+'\x20bytes');}catch(l){console['error']('❌\x20Failed\x20to\x20update\x20usage\x20for\x20'+b+':\x20'+l['message']);}finally{f&&await kvDelete(a['DB'],e);}}async function cleanupOldIps(a,b){if(!a['DB'])return;try{const c=a['DB']['prepare']('DELETE\x20FROM\x20user_ips\x20WHERE\x20last_seen\x20<\x20datetime(\x27now\x27,\x20?)')['bind']('-'+CONST['IP_CLEANUP_AGE_DAYS']+'\x20days')['run']();b?b['waitUntil'](c):await c;}catch(d){console['error']('❌\x20IP\x20cleanup\x20failed:\x20'+d['message']);}}async function isSuspiciousIP(a,b,c=CONST['SCAMALYTICS_THRESHOLD']){if(!b['username']||!b['apiKey'])return console['warn']('⚠️\x20Scamalytics\x20API\x20credentials\x20not\x20configured.\x20IP\x20'+a+'\x20allowed\x20by\x20default\x20(fail-open\x20mode).'),![];const d=new AbortController(),f=setTimeout(()=>d['abort'](),0x1388);try{const g=b['baseUrl']+'score?username='+b['username']+'&ip='+a+'&key='+b['apiKey'],h=await fetch(g,{'signal':d['signal']});if(!h['ok'])return console['warn']('Scamalytics\x20API\x20returned\x20'+h['status']+'\x20for\x20'+a+'.\x20Allowing\x20(fail-open).'),![];const i=await h['json']();return i['score']>=c;}catch(j){return j['name']==='AbortError'?console['warn']('Scamalytics\x20timeout\x20for\x20'+a+'.\x20Allowing\x20(fail-open).'):console['error']('Scamalytics\x20error\x20for\x20'+a+':\x20'+j['message']+'.\x20Allowing\x20(fail-open).'),![];}finally{clearTimeout(f);}}function base32ToBuffer(a){const b='ABCDEFGHIJKLMNOPQRSTUVWXYZ234567',c=a['toUpperCase']()['replace'](/=+$/,'');let d=0x0,e=0x0,f=0x0;const g=new Uint8Array(Math['floor'](c['length']*0x5/0x8));for(let h=0x0;h<c['length'];h++){const j=c[h],k=b['indexOf'](j);if(k===-0x1)throw new Error('Invalid\x20Base32\x20character');e=e<<0x5|k,d+=0x5,d>=0x8&&(g[f++]=e>>>d-0x8&0xff,d-=0x8);}return g['buffer'];}async function generateHOTP(a,b){const c=new ArrayBuffer(0x8),d=new DataView(c);d['setBigUint64'](0x0,BigInt(b),![]);const e=await crypto['subtle']['importKey']('raw',a,{'name':'HMAC','hash':'SHA-1'},![],['sign']),f=await crypto['subtle']['sign']('HMAC',e,c),g=new Uint8Array(f),h=g[g['length']-0x1]&0xf,i=(g[h]&0x7f)<<0x18|(g[h+0x1]&0xff)<<0x10|(g[h+0x2]&0xff)<<0x8|g[h+0x3]&0xff,j=i%0xf4240;return j['toString']()['padStart'](0x6,'0');}async function validateTOTP(a,b){if(!a||!b||b['length']!==0x6||!/^\d{6}$/['test'](b))return![];let c;try{c=base32ToBuffer(a);}catch(i){return console['error']('Failed\x20to\x20decode\x20TOTP\x20secret:',i['message']),![];}const d=0x1e,f=Math['floor'](Date['now']()/0x3e8),g=Math['floor'](f/d),h=[g,g-0x1,g+0x1];for(const j of h){const k=await generateHOTP(c,j);if(timingSafeEqual(b,k))return!![];}return![];}async function hashSHA256(a){const b=new TextEncoder(),c=b['encode'](a),d=await crypto['subtle']['digest']('SHA-256',c),e=Array['from'](new Uint8Array(d));return e['map'](f=>f['toString'](0x10)['padStart'](0x2,'0'))['join']('');}async function checkRateLimit(a,b,c,d){if(!a)return![];try{const f=await kvGet(a,b),g=parseInt(f,0xa)||0x0;if(g>=c)return!![];return await kvPut(a,b,(g+0x1)['toString'](),{'expirationTtl':d}),![];}catch(h){return console['error']('Rate\x20limit\x20check\x20failed\x20for\x20'+b+':\x20'+h['message']),![];}}const byteToHex=Array['from']({'length':0x100},(a,b)=>(b+0x100)['toString'](0x10)['slice'](0x1));function unsafeStringify(a,b=0x0){return(byteToHex[a[b]]+byteToHex[a[b+0x1]]+byteToHex[a[b+0x2]]+byteToHex[a[b+0x3]]+'-'+byteToHex[a[b+0x4]]+byteToHex[a[b+0x5]]+'-'+byteToHex[a[b+0x6]]+byteToHex[a[b+0x7]]+'-'+byteToHex[a[b+0x8]]+byteToHex[a[b+0x9]]+'-'+byteToHex[a[b+0xa]]+byteToHex[a[b+0xb]]+byteToHex[a[b+0xc]]+byteToHex[a[b+0xd]]+byteToHex[a[b+0xe]]+byteToHex[a[b+0xf]])['toLowerCase']();}function stringify(a,b=0x0){const c=unsafeStringify(a,b);if(!isValidUUID(c))throw new TypeError('Stringified\x20UUID\x20is\x20invalid');return c;}function generateRandomPath(a=0xc,b=''){const c='ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';let d='';for(let e=0x0;e<a;e++){d+=c['charAt'](Math['floor'](Math['random']()*c['length']));}return'/'+d+(b?'?'+b:'');}const CORE_PRESETS={'xray':{'tls':{'path':()=>generateRandomPath(0xc,'ed=2048'),'security':'tls','fp':'chrome','alpn':'http/1.1','extra':{}},'tcp':{'path':()=>generateRandomPath(0xc,'ed=2048'),'security':'none','fp':'chrome','extra':{}}},'sb':{'tls':{'path':()=>generateRandomPath(0x12),'security':'tls','fp':'firefox','alpn':'h3','extra':CONST['ED_PARAMS']},'tcp':{'path':()=>generateRandomPath(0x12),'security':'none','fp':'firefox','extra':CONST['ED_PARAMS']}}};function makeName(a,b){return a+'-'+b['toUpperCase']();}function createVlessLink({userID:a,address:b,port:c,host:d,path:e,security:f,sni:g,fp:h,alpn:i,extra:extra={},name:j}){const l=new URLSearchParams({'type':'ws','host':d,'path':e});if(f)l['set']('security',f);if(g)l['set']('sni',g);if(h)l['set']('fp',h);if(i)l['set']('alpn',i);for(const [m,n]of Object['entries'](extra))l['set'](m,n);return'vless://'+a+'@'+b+':'+c+'?'+l['toString']()+'#'+encodeURIComponent(j);}function buildLink({core:a,proto:b,userID:c,hostName:d,address:e,port:f,tag:g}){const h=CORE_PRESETS[a][b];return createVlessLink({'userID':c,'address':e,'port':f,'host':d,'path':h['path'](),'security':h['security'],'sni':h['security']==='tls'?d:undefined,'fp':h['fp'],'alpn':h['alpn'],'extra':h['extra'],'name':makeName(g,b)});}const pick=a=>a[Math['floor'](Math['random']()*a['length'])];async function handleIpSubscription(a,b,c){const d=[c,'creativecommons.org','mail.tm','temp-mail.org','ipaddress.my','mdbmax.com','check-host.net','kodambroker.com','iplocation.io','whatismyip.org','ifciran.net','whatismyip.com','www.speedtest.net','www.linkedin.com','exir.io','arzex.io','ok-ex.io','arzdigital.com','pouyanit.com','auth.grok.com','grok.com','whatismyip.live','whatismyip.org','maxmind.com','whatsmyip.com','iplocation.net','ipchicken.com','showmyip.com','whatsmyip.now','router-network.com','sky.rethinkdns.com','cfip.1323123.xyz','go.inmobi.com','whatismyipaddress.com','cf.090227.xyz','cdnjs.com','zula.ir'],f=[0x1bb,0x20fb,0x805,0x823,0x827,0x830],g=[0x50,0x1f90,0x22b0,0x804,0x822,0x826,0x82f];let h=[];const i=c['endsWith']('.pages.dev');d['forEach']((k,l)=>{h['push'](buildLink({'core':a,'proto':'tls','userID':b,'hostName':c,'address':k,'port':pick(f),'tag':'D'+(l+0x1)})),!i&&h['push'](buildLink({'core':a,'proto':'tcp','userID':b,'hostName':c,'address':k,'port':pick(g),'tag':'D'+(l+0x1)}));});try{const k=await fetch('https://raw.githubusercontent.com/NiREvil/vless/refs/heads/main/Cloudflare-IPs.json');if(k['ok']){const l=await k['json'](),m=[...l['ipv4']??[],...l['ipv6']??[]]['slice'](0x0,0x14)['map'](n=>n['ip']);m['forEach']((n,o)=>{const p=n['includes'](':')?'['+n+']':n;h['push'](buildLink({'core':a,'proto':'tls','userID':b,'hostName':c,'address':p,'port':pick(f),'tag':'IP'+(o+0x1)})),!i&&h['push'](buildLink({'core':a,'proto':'tcp','userID':b,'hostName':c,'address':p,'port':pick(g),'tag':'IP'+(o+0x1)}));});}}catch(n){console['error']('Fetch\x20IP\x20list\x20failed',n);}const j=new Headers({'Content-Type':'text/plain;charset=utf-8'});return addSecurityHeaders(j,null,{}),new Response(btoa(h['join']('\x0a')),{'headers':j});}const adminLoginHTML='<!DOCTYPE\x20html>\x0a<html\x20lang=\x22en\x22>\x0a<head>\x0a\x20\x20\x20\x20<meta\x20charset=\x22UTF-8\x22>\x0a\x20\x20\x20\x20<meta\x20name=\x22viewport\x22\x20content=\x22width=device-width,\x20initial-scale=1.0\x22>\x0a\x20\x20\x20\x20<title>Admin\x20Login</title>\x0a\x20\x20\x20\x20<style\x20nonce=\x22CSP_NONCE_PLACEHOLDER\x22>\x0a\x20\x20\x20\x20\x20\x20\x20\x20body\x20{\x20display:\x20flex;\x20justify-content:\x20center;\x20align-items:\x20center;\x20height:\x20100vh;\x20margin:\x200;\x20background-color:\x20#121212;\x20font-family:\x20-apple-system,\x20BlinkMacSystemFont,\x20\x22Segoe\x20UI\x22,\x20Roboto,\x20Helvetica,\x20Arial,\x20sans-serif;\x20}\x0a\x20\x20\x20\x20\x20\x20\x20\x20.login-container\x20{\x20background-color:\x20#1e1e1e;\x20padding:\x2040px;\x20border-radius:\x2012px;\x20box-shadow:\x200\x204px\x2020px\x20rgba(0,\x200,\x200,\x200.5);\x20text-align:\x20center;\x20width:\x20320px;\x20border:\x201px\x20solid\x20#333;\x20}\x0a\x20\x20\x20\x20\x20\x20\x20\x20h1\x20{\x20color:\x20#ffffff;\x20margin-bottom:\x2024px;\x20font-weight:\x20500;\x20}\x0a\x20\x20\x20\x20\x20\x20\x20\x20form\x20{\x20display:\x20flex;\x20flex-direction:\x20column;\x20}\x0a\x20\x20\x20\x20\x20\x20\x20\x20input[type=\x22password\x22],\x20input[type=\x22text\x22]\x20{\x20background-color:\x20#2c2c2c;\x20border:\x201px\x20solid\x20#444;\x20color:\x20#ffffff;\x20padding:\x2012px;\x20border-radius:\x208px;\x20margin-bottom:\x2020px;\x20font-size:\x2016px;\x20box-sizing:\x20border-box;\x20width:\x20100%;\x20}\x0a\x20\x20\x20\x20\x20\x20\x20\x20input[type=\x22password\x22]:focus,\x20input[type=\x22text\x22]:focus\x20{\x20outline:\x20none;\x20border-color:\x20#007aff;\x20box-shadow:\x200\x200\x200\x202px\x20rgba(0,\x20122,\x20255,\x200.3);\x20}\x0a\x20\x20\x20\x20\x20\x20\x20\x20button\x20{\x20background-color:\x20#007aff;\x20color:\x20white;\x20border:\x20none;\x20padding:\x2012px;\x20border-radius:\x208px;\x20font-size:\x2016px;\x20font-weight:\x20600;\x20cursor:\x20pointer;\x20transition:\x20background-color\x200.2s;\x20}\x0a\x20\x20\x20\x20\x20\x20\x20\x20button:hover\x20{\x20background-color:\x20#005ecb;\x20}\x0a\x20\x20\x20\x20\x20\x20\x20\x20.error\x20{\x20color:\x20#ff3b30;\x20margin-top:\x2015px;\x20font-size:\x2014px;\x20}\x0a\x20\x20\x20\x20\x20\x20\x20\x20@media\x20(max-width:\x20400px)\x20{\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20.login-container\x20{\x20width:\x2090%;\x20padding:\x2025px;\x20}\x0a\x20\x20\x20\x20\x20\x20\x20\x20}\x0a\x20\x20\x20\x20</style>\x0a</head>\x0a<body>\x0a\x20\x20\x20\x20<div\x20class=\x22login-container\x22>\x0a\x20\x20\x20\x20\x20\x20\x20\x20<h1>Admin\x20Login</h1>\x0a\x20\x20\x20\x20\x20\x20\x20\x20<form\x20method=\x22POST\x22\x20action=\x22ADMIN_PATH_PLACEHOLDER\x22>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<input\x20type=\x22password\x22\x20name=\x22password\x22\x20placeholder=\x22Enter\x20admin\x20password\x22\x20required>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<input\x20type=\x22text\x22\x20name=\x22totp\x22\x20placeholder=\x22Enter\x20TOTP\x20code\x20(if\x20enabled)\x22\x20autocomplete=\x22off\x22\x20/>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<button\x20type=\x22submit\x22>Login</button>\x0a\x20\x20\x20\x20\x20\x20\x20\x20</form>\x0a\x20\x20\x20\x20</div>\x0a</body>\x0a</html>';async function isAdmin(a,b){if(!b['DB'])return![];try{const c=a['headers']['get']('Cookie');if(!c)return![];const d=c['match'](/auth_token=([^;]+)/)?.[0x1];if(!d)return![];const f=await hashSHA256(d),g=await kvGet(b['DB'],'admin_session_token_hash');return g&&timingSafeEqual(f,g);}catch(h){return console['error']('isAdmin\x20check\x20failed:\x20'+h['message']),![];}}async function handleAdminRequest(a,b,c,d){const f=await ensureTablesExist(b,c);if(!f){const n=new Headers({'Content-Type':'text/html;charset=utf-8'});return addSecurityHeaders(n,null,{}),new Response('Database\x20not\x20available.\x20Admin\x20panel\x20requires\x20D1\x20database.',{'status':0x1f7,'headers':n});}const g=new URL(a['url']),h={'Content-Type':'application/json'},i=new Headers({'Content-Type':'text/html;charset=utf-8'}),j=a['headers']['get']('CF-Connecting-IP');if(!b['ADMIN_KEY'])return addSecurityHeaders(i,null,{}),new Response('Admin\x20panel\x20is\x20not\x20configured.',{'status':0x1f7,'headers':i});if(b['ADMIN_IP_WHITELIST']){const o=b['ADMIN_IP_WHITELIST']['split'](',')['map'](p=>p['trim']());if(!o['includes'](j))return console['warn']('Admin\x20access\x20denied\x20for\x20IP:\x20'+j+'\x20(Not\x20in\x20whitelist)'),addSecurityHeaders(i,null,{}),new Response('Access\x20denied.',{'status':0x193,'headers':i});}else{const p={'username':b['SCAMALYTICS_USERNAME']||Config['scamalytics']['username'],'apiKey':b['SCAMALYTICS_API_KEY']||Config['scamalytics']['apiKey'],'baseUrl':b['SCAMALYTICS_BASEURL']||Config['scamalytics']['baseUrl']};try{if(await isSuspiciousIP(j,p,b['SCAMALYTICS_THRESHOLD']||CONST['SCAMALYTICS_THRESHOLD']))return console['warn']('Admin\x20access\x20denied\x20for\x20suspicious\x20IP:\x20'+j),addSecurityHeaders(i,null,{}),new Response('Access\x20denied.',{'status':0x193,'headers':i});}catch(q){console['error']('Scamalytics\x20check\x20failed:\x20'+q['message']+'\x20-\x20Allowing\x20access');}}if(b['ADMIN_HEADER_KEY']){const r=a['headers']['get']('X-Admin-Auth');if(!timingSafeEqual(r||'',b['ADMIN_HEADER_KEY']))return addSecurityHeaders(i,null,{}),new Response('Access\x20denied.',{'status':0x193,'headers':i});}const k='/'+d+'/'+b['ADMIN_KEY'];if(!g['pathname']['startsWith'](k)){const s=new Headers();return addSecurityHeaders(s,null,{}),new Response('Not\x20found',{'status':0x194,'headers':s});}const l=g['pathname']['substring'](k['length'])||'/';if(l['startsWith']('/api/')){if(!await isAdmin(a,b)){const v=new Headers(h);return addSecurityHeaders(v,null,{}),new Response(JSON['stringify']({'error':'Forbidden'}),{'status':0x193,'headers':v});}try{const w='admin_api_rate:'+j;if(await checkRateLimit(b['DB'],w,0x64,0x3c)){const x=new Headers(h);return addSecurityHeaders(x,null,{}),new Response(JSON['stringify']({'error':'API\x20rate\x20limit\x20exceeded'}),{'status':0x1ad,'headers':x});}}catch(y){console['warn']('Rate\x20limit\x20check\x20failed:\x20'+y['message']);}if(a['method']!=='GET')try{const z=a['headers']['get']('Origin'),A=a['headers']['get']('Sec-Fetch-Site');if(!z||new URL(z)['hostname']!==g['hostname']||A!=='same-origin'){const D=new Headers(h);return addSecurityHeaders(D,null,{}),new Response(JSON['stringify']({'error':'Invalid\x20Origin/Request'}),{'status':0x193,'headers':D});}const B=a['headers']['get']('X-CSRF-Token'),C=a['headers']['get']('Cookie')?.['match'](/csrf_token=([^;]+)/)?.[0x1];if(!B||!C||!timingSafeEqual(B,C)){const E=new Headers(h);return addSecurityHeaders(E,null,{}),new Response(JSON['stringify']({'error':'CSRF\x20validation\x20failed'}),{'status':0x193,'headers':E});}}catch(F){console['error']('CSRF\x20validation\x20error:\x20'+F['message']);const G=new Headers(h);return addSecurityHeaders(G,null,{}),new Response(JSON['stringify']({'error':'Security\x20validation\x20failed'}),{'status':0x193,'headers':G});}if(l==='/api/stats'&&a['method']==='GET'){const H=new Headers(h);addSecurityHeaders(H,null,{});try{const I=await b['DB']['prepare']('SELECT\x20COUNT(*)\x20as\x20count\x20FROM\x20users')['first']('count')||0x0,J=await b['DB']['prepare']('SELECT\x20COUNT(*)\x20as\x20count\x20FROM\x20users\x20WHERE\x20datetime(expiration_date\x20||\x20\x27T\x27\x20||\x20expiration_time\x20||\x20\x27Z\x27)\x20<\x20datetime(\x27now\x27)')['first'](),K=J?.['count']||0x0,L=I-K,M=await b['DB']['prepare']('SELECT\x20SUM(traffic_used)\x20as\x20sum\x20FROM\x20users')['first'](),N=M?.['sum']||0x0;return new Response(JSON['stringify']({'total_users':I,'active_users':L,'expired_users':K,'total_traffic':N}),{'status':0xc8,'headers':H});}catch(O){return console['error']('Stats\x20API\x20error:\x20'+O['message']),new Response(JSON['stringify']({'error':O['message']}),{'status':0x1f4,'headers':H});}}if(l==='/api/users'&&a['method']==='GET'){const P=new Headers(h);addSecurityHeaders(P,null,{});try{const {results:Q}=await b['DB']['prepare']('SELECT\x20uuid,\x20created_at,\x20expiration_date,\x20expiration_time,\x20notes,\x20traffic_limit,\x20traffic_used,\x20ip_limit\x20FROM\x20users\x20ORDER\x20BY\x20created_at\x20DESC')['all']();return new Response(JSON['stringify'](Q??[]),{'status':0xc8,'headers':P});}catch(R){return console['error']('Users\x20list\x20API\x20error:\x20'+R['message']),new Response(JSON['stringify']({'error':R['message']}),{'status':0x1f4,'headers':P});}}if(l==='/api/users'&&a['method']==='POST'){const S=new Headers(h);addSecurityHeaders(S,null,{});try{const {uuid:T,exp_date:U,exp_time:V,notes:W,traffic_limit:X,ip_limit:Y}=await a['json']();if(!T||!U||!V||!/^\d{4}-\d{2}-\d{2}$/['test'](U)||!/^\d{2}:\d{2}:\d{2}$/['test'](V))throw new Error('Invalid\x20or\x20missing\x20fields.\x20Use\x20UUID,\x20YYYY-MM-DD,\x20and\x20HH:MM:SS.');return await b['DB']['prepare']('INSERT\x20INTO\x20users\x20(uuid,\x20expiration_date,\x20expiration_time,\x20notes,\x20traffic_limit,\x20ip_limit,\x20traffic_used)\x20VALUES\x20(?,\x20?,\x20?,\x20?,\x20?,\x20?,\x200)')['bind'](T,U,V,W||null,X,Y||-0x1)['run'](),c['waitUntil'](kvPut(b['DB'],'user:'+T,{'uuid':T,'expiration_date':U,'expiration_time':V,'notes':W||null,'traffic_limit':X,'ip_limit':Y||-0x1,'traffic_used':0x0},{'expirationTtl':0xe10})),new Response(JSON['stringify']({'success':!![],'uuid':T}),{'status':0xc9,'headers':S});}catch(Z){console['error']('Create\x20user\x20API\x20error:\x20'+Z['message']);if(Z['message']?.['includes']('UNIQUE\x20constraint\x20failed'))return new Response(JSON['stringify']({'error':'A\x20user\x20with\x20this\x20UUID\x20already\x20exists.'}),{'status':0x199,'headers':S});return new Response(JSON['stringify']({'error':Z['message']}),{'status':0x190,'headers':S});}}if(l==='/api/users/bulk-delete'&&a['method']==='POST'){const a0=new Headers(h);addSecurityHeaders(a0,null,{});try{const {uuids:a1}=await a['json']();if(!Array['isArray'](a1)||a1['length']===0x0)throw new Error('Invalid\x20request\x20body:\x20Expected\x20an\x20array\x20of\x20UUIDs.');const a2=b['DB']['prepare']('DELETE\x20FROM\x20users\x20WHERE\x20uuid\x20=\x20?'),a3=a1['map'](a4=>a2['bind'](a4));return await b['DB']['batch'](a3),c['waitUntil'](Promise['all'](a1['map'](a4=>kvDelete(b['DB'],'user:'+a4)))),new Response(JSON['stringify']({'success':!![],'count':a1['length']}),{'status':0xc8,'headers':a0});}catch(a4){return console['error']('Bulk\x20delete\x20API\x20error:\x20'+a4['message']),new Response(JSON['stringify']({'error':a4['message']}),{'status':0x190,'headers':a0});}}const t=l['match'](/^\/api\/users\/([a-f0-9-]+)$/);if(t&&a['method']==='PUT'){const a5=new Headers(h);addSecurityHeaders(a5,null,{});const a6=t[0x1];try{const {exp_date:a7,exp_time:a8,notes:a9,traffic_limit:aa,ip_limit:ab,reset_traffic:ac}=await a['json']();if(!a7||!a8||!/^\d{4}-\d{2}-\d{2}$/['test'](a7)||!/^\d{2}:\d{2}:\d{2}$/['test'](a8))throw new Error('Invalid\x20date/time\x20fields.\x20Use\x20YYYY-MM-DD\x20and\x20HH:MM:SS.');let ad='UPDATE\x20users\x20SET\x20expiration_date\x20=\x20?,\x20expiration_time\x20=\x20?,\x20notes\x20=\x20?,\x20traffic_limit\x20=\x20?,\x20ip_limit\x20=\x20?',ae=[a7,a8,a9||null,aa,ab||-0x1];return ac&&(ad+=',\x20traffic_used\x20=\x200'),ad+='\x20WHERE\x20uuid\x20=\x20?',ae['push'](a6),await b['DB']['prepare'](ad)['bind'](...ae)['run'](),c['waitUntil'](kvDelete(b['DB'],'user:'+a6)),new Response(JSON['stringify']({'success':!![],'uuid':a6}),{'status':0xc8,'headers':a5});}catch(af){return console['error']('Update\x20user\x20API\x20error:\x20'+af['message']),new Response(JSON['stringify']({'error':af['message']}),{'status':0x190,'headers':a5});}}if(t&&a['method']==='DELETE'){const ag=new Headers(h);addSecurityHeaders(ag,null,{});const ah=t[0x1];try{return await b['DB']['prepare']('DELETE\x20FROM\x20users\x20WHERE\x20uuid\x20=\x20?')['bind'](ah)['run'](),c['waitUntil'](kvDelete(b['DB'],'user:'+ah)),new Response(JSON['stringify']({'success':!![],'uuid':ah}),{'status':0xc8,'headers':ag});}catch(ai){return console['error']('Delete\x20user\x20API\x20error:\x20'+ai['message']),new Response(JSON['stringify']({'error':ai['message']}),{'status':0x1f4,'headers':ag});}}if(l==='/api/logout'&&a['method']==='POST'){const aj=new Headers(h);addSecurityHeaders(aj,null,{});try{await kvDelete(b['DB'],'admin_session_token_hash');const ak=['auth_token=;\x20Max-Age=0;\x20Path=/;\x20Secure;\x20HttpOnly;\x20SameSite=Strict','csrf_token=;\x20Max-Age=0;\x20Path=/;\x20Secure;\x20SameSite=Strict'];return aj['append']('Set-Cookie',ak[0x0]),aj['append']('Set-Cookie',ak[0x1]),new Response(JSON['stringify']({'success':!![]}),{'status':0xc8,'headers':aj});}catch(al){return console['error']('Logout\x20API\x20error:\x20'+al['message']),new Response(JSON['stringify']({'error':al['message']}),{'status':0x1f4,'headers':aj});}}if(l==='/api/health-check'&&a['method']==='POST'){const am=new Headers(h);addSecurityHeaders(am,null,{});try{return await performHealthCheck(b,c),new Response(JSON['stringify']({'success':!![]}),{'status':0xc8,'headers':am});}catch(an){return console['error']('Health\x20check\x20API\x20error:\x20'+an['message']),new Response(JSON['stringify']({'error':an['message']}),{'status':0x1f4,'headers':am});}}const u=new Headers(h);return addSecurityHeaders(u,null,{}),new Response(JSON['stringify']({'error':'API\x20route\x20not\x20found'}),{'status':0x194,'headers':u});}if(l==='/'){if(a['method']==='POST'){const ap='login_fail_ip:'+j;try{const aq=await kvGet(b['DB'],ap),ar=parseInt(aq,0xa)||0x0;if(ar>=CONST['ADMIN_LOGIN_FAIL_LIMIT'])return addSecurityHeaders(i,null,{}),new Response('Too\x20many\x20failed\x20login\x20attempts.\x20Please\x20try\x20again\x20later.',{'status':0x1ad,'headers':i});const as=await a['formData']();if(timingSafeEqual(as['get']('password'),b['ADMIN_KEY'])){if(b['ADMIN_TOTP_SECRET']){const ax=as['get']('totp');if(!await validateTOTP(b['ADMIN_TOTP_SECRET'],ax)){const ay=generateNonce();addSecurityHeaders(i,ay,{});let az=adminLoginHTML['replace']('</form>','</form><p\x20class=\x22error\x22>Invalid\x20TOTP\x20code.\x20Attempt\x20'+(ar+0x1)+'\x20of\x20'+CONST['ADMIN_LOGIN_FAIL_LIMIT']+'.</p>');return az=az['replace'](/CSP_NONCE_PLACEHOLDER/g,ay),az=az['replace']('action=\x22ADMIN_PATH_PLACEHOLDER\x22','action=\x22'+k+'\x22'),new Response(az,{'status':0x191,'headers':i});}}const at=crypto['randomUUID'](),au=crypto['randomUUID'](),av=await hashSHA256(at);c['waitUntil'](Promise['all']([kvPut(b['DB'],'admin_session_token_hash',av,{'expirationTtl':0x15180}),kvDelete(b['DB'],ap)]));const aw=new Headers({'Location':k});return aw['append']('Set-Cookie','auth_token='+at+';\x20HttpOnly;\x20Secure;\x20Path='+k+';\x20Max-Age=86400;\x20SameSite=Strict'),aw['append']('Set-Cookie','csrf_token='+au+';\x20Secure;\x20Path='+k+';\x20Max-Age=86400;\x20SameSite=Strict'),addSecurityHeaders(aw,null,{}),new Response(null,{'status':0x12e,'headers':aw});}else{c['waitUntil'](kvPut(b['DB'],ap,(ar+0x1)['toString'](),{'expirationTtl':CONST['ADMIN_LOGIN_LOCK_TTL']}));const aA=generateNonce();addSecurityHeaders(i,aA,{});let aB=adminLoginHTML['replace']('</form>','</form><p\x20class=\x22error\x22>Invalid\x20password.\x20Attempt\x20'+(ar+0x1)+'\x20of\x20'+CONST['ADMIN_LOGIN_FAIL_LIMIT']+'.</p>');return aB=aB['replace'](/CSP_NONCE_PLACEHOLDER/g,aA),aB=aB['replace']('action=\x22ADMIN_PATH_PLACEHOLDER\x22','action=\x22'+k+'\x22'),new Response(aB,{'status':0x191,'headers':i});}}catch(aC){return console['error']('Admin\x20login\x20error:',aC['stack']),addSecurityHeaders(i,null,{}),new Response('An\x20internal\x20error\x20occurred\x20during\x20login.',{'status':0x1f4,'headers':i});}}if(a['method']==='GET'){const aD=generateNonce();addSecurityHeaders(i,aD,{});let aE;return await isAdmin(a,b)?(aE='<!--\x20INSERT\x20FULL\x20adminPanelHTML\x20HERE\x20-->',aE=aE['replace']('\x27ADMIN_API_BASE_PATH_PLACEHOLDER\x27','\x27'+k+'/api\x27')):(aE=adminLoginHTML,aE=aE['replace']('action=\x22ADMIN_PATH_PLACEHOLDER\x22','action=\x22'+k+'\x22')),aE=aE['replace'](/CSP_NONCE_PLACEHOLDER/g,aD),new Response(aE,{'headers':i});}const ao=new Headers();return addSecurityHeaders(ao,null,{}),new Response('Method\x20Not\x20Allowed',{'status':0x195,'headers':ao});}const m=new Headers();return addSecurityHeaders(m,null,{}),new Response('Not\x20found',{'status':0x194,'headers':m});}async function ProtocolOverWSHandler(a,b,c,d){const f=a['headers']['get']('CF-Connecting-IP');try{if(await isSuspiciousIP(f,b['scamalytics'],c['SCAMALYTICS_THRESHOLD']||CONST['SCAMALYTICS_THRESHOLD']))return new Response('Access\x20denied',{'status':0x193});}catch(v){console['warn']('Scamalytics\x20check\x20failed:\x20'+v['message']+'\x20-\x20Allowing\x20connection');}const g=new WebSocketPair(),[h,i]=Object['values'](g);try{i['accept']();}catch(w){return console['error']('WebSocket\x20accept\x20failed:\x20'+w['message']),new Response('Connection\x20failed',{'status':0x1f4});}let j='',k='',l=0x0,m='',n=null;const o=(x,y)=>console['log']('['+j+':'+k+']\x20'+x,y||''),p=()=>{if(l>0x0&&m&&c['DB']){const x=l,y=m;l=0x0,d['waitUntil'](updateUsage(c,y,x,d)['catch'](z=>console['error']('❌\x20Deferred\x20usage\x20update\x20failed\x20for\x20'+y+':',z)));}},q=setInterval(p,0x2710),r=()=>{clearInterval(q),p();};i['addEventListener']('close',r,{'once':!![]}),i['addEventListener']('error',r,{'once':!![]});const s=a['headers']['get']('Sec-WebSocket-Protocol')||'';let t;try{t=MakeReadableWebSocketStream(i,s,o);}catch(x){return console['error']('❌\x20Failed\x20to\x20create\x20readable\x20stream:\x20'+x['message']),safeCloseWebSocket(i),r(),new Response('Stream\x20creation\x20failed',{'status':0x1f4});}let u={'value':null};return t['pipeTo'](new WritableStream({async 'write'(y,z){l+=y['byteLength'];if(n)try{return await n['write'](y);}catch(J){console['error']('❌\x20UDP\x20write\x20error:\x20'+J['message']),z['error'](new Error('UDP\x20write\x20failed'));return;}if(u['value'])try{const K=u['value']['writable']['getWriter']();await K['write'](y),K['releaseLock']();return;}catch(L){console['error']('❌\x20Remote\x20socket\x20write\x20error:\x20'+L['message']),z['error'](new Error('Socket\x20write\x20failed'));return;}let A;try{A=await ProcessProtocolHeader(y,c,d);}catch(M){console['error']('❌\x20Protocol\x20header\x20processing\x20failed:\x20'+M['message']),z['error'](new Error('Protocol\x20processing\x20failed'));return;}const {user:B,hasError:C,message:D,addressType:E,portRemote:portRemote=0x1bb,addressRemote:addressRemote='',rawDataIndex:F,ProtocolVersion:ProtocolVersion=new Uint8Array([0x0,0x0]),isUDP:G}=A;if(C||!B){console['warn']('❌\x20Authentication\x20failed:\x20'+(D||'Unknown\x20error')),z['error'](new Error('Authentication\x20failed'));return;}m=B['uuid'];if(isExpired(B['expiration_date'],B['expiration_time'])){console['warn']('❌\x20Account\x20expired\x20for\x20user:\x20'+m),z['error'](new Error('Account\x20expired'));return;}if(B['traffic_limit']&&B['traffic_limit']>0x0){const N=(B['traffic_used']||0x0)+l;if(N>=B['traffic_limit']){console['warn']('❌\x20Traffic\x20limit\x20exceeded\x20for\x20user:\x20'+m),z['error'](new Error('Traffic\x20limit\x20exceeded'));return;}}if(B['ip_limit']&&B['ip_limit']>-0x1&&c['DB'])try{const O=await c['DB']['prepare']('SELECT\x20COUNT(DISTINCT\x20ip)\x20as\x20count\x20FROM\x20user_ips\x20WHERE\x20uuid\x20=\x20?')['bind'](m)['first']('count');if(O>=B['ip_limit']){console['warn']('❌\x20IP\x20limit\x20exceeded\x20for\x20user:\x20'+m),z['error'](new Error('IP\x20limit\x20exceeded'));return;}await c['DB']['prepare']('INSERT\x20OR\x20REPLACE\x20INTO\x20user_ips\x20(uuid,\x20ip,\x20last_seen)\x20VALUES\x20(?,\x20?,\x20CURRENT_TIMESTAMP)')['bind'](m,f)['run']();}catch(P){console['error']('❌\x20IP\x20limit\x20check\x20failed:\x20'+P['message']+'\x20-\x20Continuing\x20without\x20IP\x20tracking');}j=addressRemote,k=portRemote+'--'+Math['random']()+'\x20'+(G?'udp':'tcp');const H=new Uint8Array([ProtocolVersion[0x0],0x0]),I=y['slice'](F);if(G){if(portRemote===0x35)try{const Q=await createDnsPipeline(i,H,o,R=>{l+=R;});n=Q['write'],await n(I);}catch(R){console['error']('❌\x20DNS\x20pipeline\x20creation\x20failed:\x20'+R['message']),z['error'](new Error('DNS\x20pipeline\x20failed'));}else console['warn']('❌\x20Unsupported\x20UDP\x20port:\x20'+portRemote),z['error'](new Error('Unsupported\x20UDP\x20port'));return;}try{await HandleTCPOutBound(u,E,addressRemote,portRemote,I,i,H,o,b,S=>{l+=S;});}catch(S){console['error']('❌\x20TCP\x20outbound\x20handling\x20failed:\x20'+S['message']),z['error'](new Error('TCP\x20connection\x20failed'));}},'close'(){o('✅\x20ReadableWebSocketStream\x20closed\x20normally'),r();},'abort'(y){o('❌\x20ReadableWebSocketStream\x20aborted',y),r();}}))['catch'](y=>{console['error']('❌\x20Pipeline\x20failed:',y['stack']||y),safeCloseWebSocket(i),r();}),new Response(null,{'status':0x65,'webSocket':h});}async function performHealthCheck(a,b){if(!a['DB']){console['warn']('⚠️\x20Health\x20check\x20skipped:\x20Database\x20not\x20available');return;}const c=a['PROXYIPS']?a['PROXYIPS']['split'](',')['map'](f=>f['trim']()):Config['proxyIPs'],d=[];for(const f of c){const [g,h='443']=f['split'](':');let i=null,j=0x0;const k=Date['now']();try{const l=new AbortController(),m=setTimeout(()=>l['abort'](),CONST['HEALTH_CHECK_TIMEOUT']),n=await fetch('https://'+g+':'+h,{'signal':l['signal']});clearTimeout(m),(n['ok']||n['status']<0x1f4)&&(i=Date['now']()-k,j=0x1,console['log']('✅\x20Health\x20check\x20passed\x20for\x20'+f+':\x20'+i+'ms'));}catch(o){console['warn']('⚠️\x20Health\x20check\x20failed\x20for\x20'+f+':\x20'+o['message']);}d['push'](a['DB']['prepare']('INSERT\x20OR\x20REPLACE\x20INTO\x20proxy_health\x20(ip_port,\x20is_healthy,\x20latency_ms,\x20last_check)\x20VALUES\x20(?,\x20?,\x20?,\x20?)')['bind'](f,j,i,Math['floor'](Date['now']()/0x3e8)));}try{await a['DB']['batch'](d),console['log']('✅\x20Proxy\x20health\x20check\x20completed\x20successfully');}catch(p){console['error']('❌\x20Failed\x20to\x20save\x20health\x20check\x20results:\x20'+p['message']);}}export default{async 'fetch'(a,b,c){try{const d=await ensureTablesExist(b,c);!d&&!b['DB']&&console['warn']('⚠️\x20Running\x20without\x20database\x20-\x20Limited\x20functionality');let f;try{f=await Config['fromEnv'](b);}catch(o){console['error']('❌\x20Configuration\x20Error:\x20'+o['message']);const p=new Headers();return addSecurityHeaders(p,null,{}),new Response('Configuration\x20Error:\x20'+o['message'],{'status':0x1f7,'headers':p});}const g=new URL(a['url']),h=a['headers']['get']('CF-Connecting-IP'),i=b['ADMIN_PATH_PREFIX']||'admin';if(g['pathname']['startsWith']('/'+i+'/'))try{return await handleAdminRequest(a,b,c,i);}catch(q){console['error']('❌\x20Admin\x20request\x20handler\x20error:\x20'+q['message']);const r=new Headers();return addSecurityHeaders(r,null,{}),new Response('Admin\x20panel\x20error\x20occurred',{'status':0x1f4,'headers':r});}if(g['pathname']==='/health'){const s=new Headers();return addSecurityHeaders(s,null,{}),new Response('OK',{'status':0xc8,'headers':s});}if(g['pathname']==='/health-check'&&a['method']==='GET')try{await performHealthCheck(b,c);const t=new Headers();return addSecurityHeaders(t,null,{}),new Response('Health\x20check\x20performed',{'status':0xc8,'headers':t});}catch(u){console['error']('❌\x20Health\x20check\x20error:\x20'+u['message']);const v=new Headers();return addSecurityHeaders(v,null,{}),new Response('Health\x20check\x20failed',{'status':0x1f4,'headers':v});}if(g['pathname']['startsWith']('/api/user/')){const w=g['pathname']['substring']('/api/user/'['length']),x=new Headers({'Content-Type':'application/json'});addSecurityHeaders(x,null,{});if(a['method']!=='GET')return new Response(JSON['stringify']({'error':'Method\x20Not\x20Allowed'}),{'status':0x195,'headers':x});if(!isValidUUID(w))return new Response(JSON['stringify']({'error':'Invalid\x20UUID'}),{'status':0x190,'headers':x});try{const y=await getUserData(b,w,c);if(!y)return new Response(JSON['stringify']({'error':'User\x20not\x20found'}),{'status':0x194,'headers':x});return new Response(JSON['stringify']({'traffic_used':y['traffic_used']||0x0,'traffic_limit':y['traffic_limit'],'expiration_date':y['expiration_date'],'expiration_time':y['expiration_time'],'status':isExpired(y['expiration_date'],y['expiration_time'])?'Expired':'Active'}),{'status':0xc8,'headers':x});}catch(z){return console['error']('❌\x20User\x20API\x20error:\x20'+z['message']),new Response(JSON['stringify']({'error':'Internal\x20server\x20error'}),{'status':0x1f4,'headers':x});}}if(g['pathname']==='/favicon.ico')return new Response(null,{'status':0x12d,'headers':{'Location':'https://www.google.com/favicon.ico'}});const j=a['headers']['get']('Upgrade');if(j?.['toLowerCase']()==='websocket'){!b['DB']&&console['warn']('⚠️\x20WebSocket\x20connection\x20without\x20database\x20-\x20Proceeding\x20with\x20limited\x20functionality');try{const A=b['HOST_HEADERS']?b['HOST_HEADERS']['split'](',')['map'](H=>H['trim']()):['speed.cloudflare.com'],B=pick(A),C=new Headers(a['headers']);C['set']('Host',B);const D=new Request(a,{'headers':C}),E={'userID':f['userID'],'proxyIP':f['proxyIP'],'proxyPort':f['proxyPort'],'socks5Address':f['socks5']['address'],'socks5Relay':f['socks5']['relayMode'],'enableSocks':f['socks5']['enabled'],'parsedSocks5Address':f['socks5']['enabled']?socks5AddressParser(f['socks5']['address']):{},'scamalytics':f['scamalytics']},F=await ProtocolOverWSHandler(D,E,b,c),G=new Headers(F['headers']);return addSecurityHeaders(G,null,{}),new Response(F['body'],{'status':F['status'],'webSocket':F['webSocket'],'headers':G});}catch(H){console['error']('❌\x20WebSocket\x20handler\x20error:\x20'+H['message']);const I=new Headers();return addSecurityHeaders(I,null,{}),new Response('WebSocket\x20connection\x20failed',{'status':0x1f4,'headers':I});}}const k=async J=>{try{if(b['DB']){const L='user_path_rate:'+h;if(await checkRateLimit(b['DB'],L,CONST['USER_PATH_RATE_LIMIT'],CONST['USER_PATH_RATE_TTL'])){const M=new Headers();return addSecurityHeaders(M,null,{}),new Response('Rate\x20limit\x20exceeded',{'status':0x1ad,'headers':M});}}const K=g['pathname']['substring'](('/'+J+'/')['length']);if(!isValidUUID(K)){const N=new Headers();return addSecurityHeaders(N,null,{}),new Response('Invalid\x20UUID',{'status':0x190,'headers':N});}if(b['DB']){const O=await getUserData(b,K,c);if(!O){const P=new Headers();return addSecurityHeaders(P,null,{}),new Response('User\x20not\x20found',{'status':0x194,'headers':P});}if(isExpired(O['expiration_date'],O['expiration_time'])){const Q=new Headers();return addSecurityHeaders(Q,null,{}),new Response('Account\x20expired',{'status':0x193,'headers':Q});}if(O['traffic_limit']&&O['traffic_limit']>0x0&&(O['traffic_used']||0x0)>=O['traffic_limit']){const R=new Headers();return addSecurityHeaders(R,null,{}),new Response('Traffic\x20limit\x20exceeded',{'status':0x193,'headers':R});}}return await handleIpSubscription(J,K,g['hostname']);}catch(S){console['error']('❌\x20Subscription\x20handler\x20error:\x20'+S['message']);const T=new Headers();return addSecurityHeaders(T,null,{}),new Response('Subscription\x20generation\x20failed',{'status':0x1f4,'headers':T});}};if(g['pathname']['startsWith']('/xray/'))return await k('xray');if(g['pathname']['startsWith']('/sb/'))return await k('sb');const l=g['pathname']['slice'](0x1);if(isValidUUID(l))try{if(b['DB']){const J='user_path_rate:'+h;if(await checkRateLimit(b['DB'],J,CONST['USER_PATH_RATE_LIMIT'],CONST['USER_PATH_RATE_TTL'])){const L=new Headers();return addSecurityHeaders(L,null,{}),new Response('Rate\x20limit\x20exceeded',{'status':0x1ad,'headers':L});}const K=await getUserData(b,l,c);if(!K){const M=new Headers();return addSecurityHeaders(M,null,{}),new Response('User\x20not\x20found',{'status':0x194,'headers':M});}return await handleUserPanel(a,l,g['hostname'],f['proxyAddress'],K,h);}else{const N=new Headers();return addSecurityHeaders(N,null,{}),new Response('User\x20panel\x20requires\x20database',{'status':0x1f7,'headers':N});}}catch(O){console['error']('❌\x20User\x20panel\x20error:\x20'+O['message']);const P=new Headers();return addSecurityHeaders(P,null,{}),new Response('User\x20panel\x20error\x20occurred',{'status':0x1f4,'headers':P});}if(b['ROOT_PROXY_URL'])try{let Q;try{Q=new URL(b['ROOT_PROXY_URL']);}catch(V){console['error']('❌\x20Invalid\x20ROOT_PROXY_URL:\x20'+b['ROOT_PROXY_URL'],V);const W=new Headers();return addSecurityHeaders(W,null,{}),new Response('Proxy\x20configuration\x20error',{'status':0x1f4,'headers':W});}const R=new URL(a['url']);R['hostname']=Q['hostname'],R['protocol']=Q['protocol'];Q['port']&&(R['port']=Q['port']);const S=new Request(R['toString'](),{'method':a['method'],'headers':a['headers'],'body':a['body'],'redirect':'manual'});S['headers']['set']('Host',Q['hostname']),S['headers']['set']('X-Forwarded-For',h),S['headers']['set']('X-Forwarded-Proto',R['protocol']['replace'](':','')),S['headers']['set']('X-Real-IP',h);const T=await fetch(S),U=new Headers(T['headers']);return U['delete']('content-security-policy-report-only'),U['delete']('x-frame-options'),!U['has']('Content-Security-Policy')&&U['set']('Content-Security-Policy','default-src\x20\x27self\x27\x20\x27unsafe-inline\x27\x20\x27unsafe-eval\x27\x20data:\x20blob:\x20*;\x20frame-ancestors\x20\x27self\x27;'),!U['has']('X-Frame-Options')&&U['set']('X-Frame-Options','SAMEORIGIN'),!U['has']('Strict-Transport-Security')&&U['set']('Strict-Transport-Security','max-age=31536000;\x20includeSubDomains'),!U['has']('X-Content-Type-Options')&&U['set']('X-Content-Type-Options','nosniff'),!U['has']('Referrer-Policy')&&U['set']('Referrer-Policy','strict-origin-when-cross-origin'),U['set']('alt-svc','h3=\x22:443\x22;\x20ma=0'),new Response(T['body'],{'status':T['status'],'statusText':T['statusText'],'headers':U});}catch(X){console['error']('❌\x20Reverse\x20Proxy\x20Error:\x20'+X['message'],X['stack']);const Y=new Headers();return addSecurityHeaders(Y,null,{}),new Response('Proxy\x20error:\x20'+X['message'],{'status':0x1f6,'headers':Y});}const m='\x0a\x20\x20\x20\x20\x20\x20\x20\x20<!DOCTYPE\x20html>\x0a\x20\x20\x20\x20\x20\x20\x20\x20<html>\x0a\x20\x20\x20\x20\x20\x20\x20\x20<head>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<title>Welcome\x20to\x20nginx!</title>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<style>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20body\x20{\x20width:\x2035em;\x20margin:\x200\x20auto;\x20font-family:\x20Tahoma,\x20Verdana,\x20Arial,\x20sans-serif;\x20}\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20</style>\x0a\x20\x20\x20\x20\x20\x20\x20\x20</head>\x0a\x20\x20\x20\x20\x20\x20\x20\x20<body>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<h1>Welcome\x20to\x20nginx!</h1>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<p>If\x20you\x20see\x20this\x20page,\x20the\x20nginx\x20web\x20server\x20is\x20successfully\x20installed\x20and\x20working.\x20Further\x20configuration\x20is\x20required.</p>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<p>For\x20online\x20documentation\x20and\x20support\x20please\x20refer\x20to\x20<a\x20href=\x22http://nginx.org/\x22>nginx.org</a>.</p>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<p><em>Thank\x20you\x20for\x20using\x20nginx.</em></p>\x0a\x20\x20\x20\x20\x20\x20\x20\x20</body>\x0a\x20\x20\x20\x20\x20\x20\x20\x20</html>\x0a\x20\x20\x20\x20\x20\x20',n=new Headers({'Content-Type':'text/html'});return addSecurityHeaders(n,null,{}),new Response(m,{'headers':n});}catch(Z){console['error']('❌\x20CRITICAL\x20ERROR\x20IN\x20MAIN\x20HANDLER:\x20'+Z['message'],Z['stack']);const a0=new Headers({'Content-Type':'text/html'});return addSecurityHeaders(a0,null,{}),new Response('\x0a\x20\x20\x20\x20\x20\x20\x20\x20<!DOCTYPE\x20html>\x0a\x20\x20\x20\x20\x20\x20\x20\x20<html>\x0a\x20\x20\x20\x20\x20\x20\x20\x20<head><title>Service\x20Temporarily\x20Unavailable</title></head>\x0a\x20\x20\x20\x20\x20\x20\x20\x20<body>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<h1>Service\x20Temporarily\x20Unavailable</h1>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<p>We\x27re\x20experiencing\x20technical\x20difficulties.\x20Please\x20try\x20again\x20in\x20a\x20few\x20moments.</p>\x0a\x20\x20\x20\x20\x20\x20\x20\x20</body>\x0a\x20\x20\x20\x20\x20\x20\x20\x20</html>\x0a\x20\x20\x20\x20\x20\x20',{'status':0x1f7,'headers':a0});}}};